<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-blog/gateway/knife4j-gateway-introduce">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="search" type="application/opensearchdescription+xml" title="Knife4j" href="/opensearch.xml">

<!-- Google Tag Manager -->
    <script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-TKBX678",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
    <!-- End Google Tag Manager -->
<script src="/js/custom.js"></script>
<script src="/js/baidu.js"></script><title data-rh="true">Spring Cloud Gateway网关下的文档聚合?就用它了 | Knife4j</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.xiaominfo.com/docs/blog/gateway/knife4j-gateway-introduce"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring Cloud Gateway网关下的文档聚合?就用它了 | Knife4j"><meta data-rh="true" name="description" content="Spring Cloud Gateway网关下的文档聚合?就用它了"><meta data-rh="true" property="og:description" content="Spring Cloud Gateway网关下的文档聚合?就用它了"><meta data-rh="true" name="keywords" content="knife4j,Spring Cloud Gateway网关聚合文档,swagger聚合,Knife4j聚合,文档聚合,微服务聚合文档"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doc.xiaominfo.com/docs/blog/gateway/knife4j-gateway-introduce"><link data-rh="true" rel="alternate" href="https://doc.xiaominfo.com/docs/blog/gateway/knife4j-gateway-introduce" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://doc.xiaominfo.com/docs/blog/gateway/knife4j-gateway-introduce" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://3CRIMRK623-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a0cea5e9.css">
<link rel="preload" href="/assets/js/runtime~main.2cdbce79.js" as="script">
<link rel="preload" href="/assets/js/main.59d021b1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/knife4j-light.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/knife4j-dark.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Knife4j</b></a><a class="navbar__item navbar__link" href="/docs/quick-start">文档</a><a class="navbar__item navbar__link changelog" href="/docs/middleware-sources">中间件</a><a aria-current="page" class="navbar__item navbar__link changelog navbar__link--active" href="/docs/blog">Blog</a><a class="navbar__item navbar__link changelog" href="/docs/action">实战指南</a><a class="navbar__item navbar__link changelog" href="/docs/changelog">更新日志</a><a class="navbar__item navbar__link changelog" href="/docs/faq">FAQ</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">旧版本</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_blank" href="/v2/index.html">2.0.9</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="toggle_MW0i colorModeToggle_x44X"><button class="clean-btn toggleButton_yw5v toggleButtonDisabled_BJd7" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）"><span><svg viewBox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="lightToggleIcon_SFTY"><g clip-path="url(#clip0_833_8168)"><path d="M6.59998 8.49999C7.98069 8.49999 9.09998 7.3807 9.09998 5.99999C9.09998 4.61928 7.98069 3.49999 6.59998 3.49999C5.21926 3.49999 4.09998 4.61928 4.09998 5.99999C4.09998 7.3807 5.21926 8.49999 6.59998 8.49999Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6.59985 0.5V1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6.59985 10.5V11.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2.7099 2.11L3.4199 2.82" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.77991 9.17999L10.4899 9.88999" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M1.09998 6H2.09998" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.0999 6H12.0999" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2.7099 9.88999L3.4199 9.17999" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.77991 2.82L10.4899 2.11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0_833_8168"><rect width="12" height="12" fill="white" transform="translate(0.599976)"></rect></clipPath></defs></svg><svg viewBox="0 0 13 12" width="14" height="14" class="darkToggleIcon_ekgs"><path d="M10.7001 6.39501C10.6215 7.24611 10.3021 8.05721 9.77927 8.7334C9.25646 9.40959 8.55189 9.92291 7.748 10.2133C6.9441 10.5036 6.07414 10.5591 5.2399 10.3731C4.40565 10.187 3.64164 9.76728 3.03726 9.1629C2.43287 8.55851 2.01312 7.7945 1.8271 6.96026C1.64108 6.12602 1.6965 5.25605 1.98688 4.45216C2.27725 3.64826 2.79056 2.94369 3.46675 2.42088C4.14294 1.89808 4.95404 1.57866 5.80515 1.50001C5.30685 2.17414 5.06707 3.00473 5.12941 3.84071C5.19175 4.6767 5.55208 5.46254 6.14485 6.05531C6.73762 6.64808 7.52346 7.0084 8.35944 7.07074C9.19542 7.13308 10.026 6.8933 10.7001 6.39501Z" stroke="currentColor" fill="transparent" stroke-linecap="round" stroke-linejoin="round"></path></svg></span></button></div><a href="https://github.com/xiaoymin/swagger-bootstrap-ui" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link icon" title="View on GitHub">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring Cloud Gateway网关下的文档聚合?就用它了</h1></header><p>大家好，这篇文章主要是介绍分享Knife4j-gateway网关聚合文档组件,自4.0版本发布该组件后，得到了大家的积极响应，我们也是积极响应用户的需求，持续迭代优化</p><p>该组件是一个非常轻量级的网关聚合组件，适用于开发者使用Spring Cloud Gateway网关组件进行Swagger2、OpenAPI3规范的文档聚合</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-1前言">🌾 1.前言<a class="hash-link" href="#-1前言" title="标题的直接链接">​</a></h2><p>在考虑写这个组件之前，开发者在Spring Cloud Gateway网关组件下进行聚合<code>Swagger2</code>/<code>OpenAPI3</code>可能存在各种各样的问题</p><p>我认为主要包括：</p><ul><li>适配不同的Spring Cloud Gateway版本，没有形成统一稳定的技术解决方案</li><li>Gateway组件下Webflux异步编码的风格，学习成本异常陡峭，初学者一时之间难以掌握微服务体系</li><li>聚合文档代码强耦合业务代码，无法灵活配置</li><li>文档Ui无法随心所欲的配置</li><li>各种404或路径错误等问题</li><li>等等.....</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-2解决方案">🔥 2.解决方案<a class="hash-link" href="#-2解决方案" title="标题的直接链接">​</a></h2><p>我们从开发者的实际需求出发，结合Knife4j多年开源以来积累的宝贵经验，决定了我们需要开发一个Gateway网关下的聚合组件</p><p>将开发者的需求、问题聚合在一起，众人拾薪火焰高，形成一个统一的技术解决方案</p><p><a href="/docs/middleware-sources/spring-cloud-gateway/spring-gateway-introduction">knife4j-gateway</a>组件就是在这样的场景下诞生的</p><p>该组件主要的特点：</p><ul><li>✅ <strong>使用简单(最低4行配置搞定聚合)，学习成本低</strong></li><li>✅ <strong>解耦Spring Cloud Gateway网关组件，聚焦文档聚合功能，职责单一</strong></li><li>✅ <strong>提供手动配置、微服务自动发现两种灵活配置方式聚合子服务文档</strong></li><li>✅ <strong>可以同时聚合Swagger2、OpenAPI3两种不同的规范</strong></li><li>✅ <strong>灵活配置聚合规则，自定义排除规则支持</strong></li><li>✅ <strong>微服务场景下支持服务的上线、下线场景，文档状态与子服务保持一致，无需重启服务</strong></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-3深入了解">🌚 3.深入了解<a class="hash-link" href="#-3深入了解" title="标题的直接链接">​</a></h2><p>我们结合knife4j-gateway组件的特点来深入分析，带着疑惑来一步步揭开她的神秘面纱~！</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-31-使用简单最低4行配置搞定聚合学习成本低">✅ <strong>3.1 使用简单(最低4行配置搞定聚合)，学习成本低</strong><a class="hash-link" href="#-31-使用简单最低4行配置搞定聚合学习成本低" title="标题的直接链接">​</a></h3><p>首先，我们既然都已经封装成组件了，那么学习和使用成本是我们首先就需要考虑的事情，需要把复杂，难处理的业务逻辑、技术细节，全部封装在组件里，而对于上层用户，我们提供简化后的配置，开发者只需要开箱即用即可</p><p>这是组件的价值，剩下学习时间成本。</p><p>当然我说使用简单(最低4行配置搞定聚合)，这只是有点宣传吹牛的口吻，对于开发者来说，我又要学习了解你这个<code>knife4j-gateway</code>组件的四行配置，那也是学习成本啊</p><p>这个我无从反驳~~~😂</p><p>如果开发者的项目、产品采用Spring Cloud微服务体系，网关组件使用Spring Cloud Gateway，那么对于Swagger、OpenAPI3的文档聚合，采用<code>knife4j-gateway</code>组件的话，就可以使用组件的<code>discover</code>自动发现模式，实现自动聚合</p><p>在项目中的<code>application.yml</code>配置文件中进行如下配置，就搞定了，配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># ① 第一个配置，开启gateway聚合组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># ② 第二行配置，设置聚合模式采用discover服务发现的模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> discover</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># ③ 第三行配置，开启discover模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># ④ 第四行配置，聚合子服务全部为Swagger2规范的文档</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> swagger2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们没有使用广告法禁止的<code>最简单</code>、<code>非常简单</code>等宣传口吻进行宣传</p><p>摸着良心去看这个配置，用<code>disocver</code>模式进行聚合，四行配置达到开发者的目的，<strong>确实</strong>很方便啊，学习成本低~~~!</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-32-解耦spring-cloud-gateway网关组件聚焦文档聚合功能职责单一">✅ 3.2 解耦Spring Cloud Gateway网关组件，聚焦文档聚合功能，职责单一<a class="hash-link" href="#-32-解耦spring-cloud-gateway网关组件聚焦文档聚合功能职责单一" title="标题的直接链接">​</a></h3><p>为什么我说解耦呢？因为文档功能其实是一个开发阶段的需求，是开发团队在配合完成项目、产品过程中，团队之前提升效率的一个潜在的需求场景</p><p>当我们的项目、产品开发完成，上线到生产环境的时候，或者在不同的项目开发过程中，开发者的需求又涌现出来了，例如：</p><ul><li>接口规范是非常重要的内部信息，生产环境应该屏蔽<blockquote><p>请参考文章<a href="/docs/blog/production-forbidden-ui">生产环境如何屏蔽Knife4j、Swagger等Ui资源和接口</a></p></blockquote></li><li>聚合代码在不同的项目中来回Copy</li><li>升级Gateway组件导致聚合代码失效，调试不同的Gateway版本，在线搜索解决方案</li><li>....</li></ul><p>还有一些其他的需求场景，一线开发者可以自行脑补，上面说列的需求，你是否在开发场景中也碰到了呢？</p><p>既然文档聚合功能和项目、产品本身并没有太大的关系，是开发者开发过程中提高效率的产物，那么对于统一的事情，我们应该避免重复操作，用独立的中间件来解决这些问题</p><p><a href="/docs/middleware-sources/spring-cloud-gateway/spring-gateway-introduction">knife4j-gateway</a>组件<strong>聚焦Swagger2/OpenAPI3规范的文档聚合</strong>,一旦团队之间确定使用Swagger2/OpenAPI3规范，并且有聚合的需求场景，那么引入一个jar组件就能解决的事情，何乐而不为呢？</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-33-提供手动配置微服务自动发现两种灵活配置方式聚合子服务文档">✅ <strong>3.3 提供手动配置、微服务自动发现两种灵活配置方式聚合子服务文档</strong><a class="hash-link" href="#-33-提供手动配置微服务自动发现两种灵活配置方式聚合子服务文档" title="标题的直接链接">​</a></h3><p>上面我们从学习成本、解耦两个方面阐述了该组件的价值，那么接下来，当我们深入去探索网关组件的下的聚合场景时，站在中间件组件的立场下，我们就需要考虑不同的团队、不同的人员的需求进行兼容合并</p><p>目前为之，结合开发任何及自身的实际工作经验，总结出了两种文档聚合的场景，供开发者进行使用</p><ul><li><strong>手动配置聚合(manual)</strong>: 开发者手动配置，灵活配置展示文档<ul><li>优点：使用简单、灵活，学习成本低.试错成本低</li><li>缺点：服务众多时较繁琐，无法感知子服务的上下线状态</li></ul></li><li><strong>服务发现自动聚合(discover)</strong>：基于注册中心，主动聚合服务<ul><li>优点：使用及配置简单、学习成本低.</li><li>缺点：暂时没想到，欢迎你来体验反馈</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-34-可以同时聚合swagger2openapi3两种不同的规范">✅ <strong>3.4 可以同时聚合Swagger2、OpenAPI3两种不同的规范</strong><a class="hash-link" href="#-34-可以同时聚合swagger2openapi3两种不同的规范" title="标题的直接链接">​</a></h3><p>我们的项目/产品在长期迭代开发过程中，或者不同的团队配合开发中,有时候子服务的标准可能不尽统一。而我们需要一起聚合怎么办呢?</p><p>好在在Knife4j的前端Ui组件已经完全适配了Swagger2和OpenAPI3规范，在网关层面，我们只需要根据该组件提供的手动配置策略配置上就解决了该问题，可参考下面的文章介绍。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-35-灵活配置聚合规则自定义排除规则支持">✅ <strong>3.5 灵活配置聚合规则，自定义排除规则支持</strong><a class="hash-link" href="#-35-灵活配置聚合规则自定义排除规则支持" title="标题的直接链接">​</a></h3><p>灵活配置是knife4j-gateway组件为网关聚合服务提供的带刀侍卫，保障开发者们在手动/服务发现两大场景下配合使用以达到最终目的</p><p>他主要提供的服务包括：</p><ul><li>设定网关层面聚合的排除规则，支持正则表达式或者开发者根据SPI接口自定义实现<blockquote><p>例如有Dubbo服务的接口，需要在网关层面进行排除，禁止聚合</p></blockquote></li><li>子服务的服务名称别名、展示顺序、接口顺序等配置自定义</li><li>子服务的自定义ContextPath自由灵活配置，满足业务需要</li></ul><p>1、在网关层面，排除不需要的子服务时，我们可以基于正则表达式(自<a href="/docs/changelog/x/4.3">4.3.0版本</a>进行支持)，配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> discover</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> swagger2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># 排除不需要聚合的子服务，基于正则表达式(支持多个)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">excluded-services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># 排除order开头的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> order.*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># 排除服务中包含dubbo字样的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> .</span><span class="token important">*?dubbo.*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2、配置子服务的别名，排序，自定义配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> discover</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> swagger2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">excluded-services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> order.*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 自定义配置子服务的别名，排序规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">service-config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">order-service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">group-name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 订单服务</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">order</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">user-service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">group-name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 用户服务</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">order</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3、网关成统一开启配置子服务的tag、operation排序规则</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> discover</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> swagger2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 排序规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">tags-sorter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> order</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">operations-sorter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> order</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-4聚焦两大使用场景手动服务发现自动聚合">🐐 4.聚焦两大使用场景(手动/服务发现自动)聚合<a class="hash-link" href="#-4聚焦两大使用场景手动服务发现自动聚合" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-手动配置聚合manual"><strong>4.1 手动配置聚合(manual)</strong><a class="hash-link" href="#41-手动配置聚合manual" title="标题的直接链接">​</a></h3><p>手动配置聚合，顾名思义,开发者需要自行写子服务的规则或者路径,这和微服务场景下自动复现聚合是形成互补机制，双剑合璧威力之下，完成最终成果输出</p><p>该场景解决不同的问题，包括：</p><ul><li>子服务同时存在Swagger2/OpenAPI3规范的服务</li><li>子服务存在不同的package包分组的的规范实例，用过springfox或者springdoc的开发者应该清楚可以根据package包路径、path路由创建接口分组</li></ul><p>如下图：</p><p><img loading="lazy" alt="图1.Spring Gateway网关聚合文档流程示意图-手动配置" src="/assets/images/knife4j-gateway-service-5ecb52aeaac526d378aca862c8542fc7.png" width="1161" height="521" class="img_ev3q"></p><p>这是一个简单的示意图，我们有三个服务：</p><ul><li>gateway-service:网关服务，负责网关路由鉴权、路由转发</li><li>order-service:子服务之一，基于OpenAPI3规范暴露规范地址:<code>/v3/api-docs</code></li><li>user-service: 子服务之一，基于Swagger2规范暴露规范地址：<code>/v2/api-docs</code></li></ul><p>我们从服务架构流程图中了解到了我们需要的信息，那么在<code>gateway-service</code>组件中，就可以使用<code>knife4j-gateway</code>组件提供的手动配置聚合，将文档进行聚合展示</p><p>简单的配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 选择手动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> manual</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">routes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 用户服务</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">service-name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /user/v2/api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">docs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 订单服务</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">service-name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> order</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /order/v3/api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">docs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-服务发现自动聚合discover"><strong>4.2 服务发现自动聚合(discover)</strong><a class="hash-link" href="#42-服务发现自动聚合discover" title="标题的直接链接">​</a></h3><p>手动聚合的唯一问题就是，一旦我们的产品/项目，子服务数量众多，纯靠手动去配，那对于开发者来说也是极其痛苦的，就好像是侮辱开发者一样。。</p><p><strong>我都能写代码了，你还让我写这么多繁杂的配置，那是对程序员的不尊重。</strong></p><p>基于服务发现自动聚合的需求场景，就由此诞生.</p><blockquote><p>在上面我们介绍knife4j-gateway特点时，我们提到该组件解耦，聚焦文档聚合功能，职责单一，这里得以体现</p></blockquote><p>对于服务发现场景下的自动聚合，配置就更简单了，但对我们也有一些小小的约束</p><blockquote><p>⚠️ 我们的子服务规范实现需要统一，要么全部用Swagger2规范，或者OpenAPI3规范</p></blockquote><p>配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># ① 第一个配置，开启gateway聚合组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># ② 第二行配置，设置聚合模式采用discover服务发现的模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> discover</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># ③ 第三行配置，开启discover模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># ④ 第四行配置，聚合子服务全部为Swagger2规范的文档</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> swagger2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个特点和我们前面提到的使用简答这一条又对上了，真的只有三四行配置。</p><p>但是在微服务聚合场景下，我们虽然封装内部实现，也有必要和大家分享一下，具体的处理规则原理</p><p>先来看一张简单的架构图-服务发现的场景，如下图：</p><p><img loading="lazy" alt="图2.Spring Gateway网关聚合文档流程示意图-服务发现" src="/assets/images/knife4j-gateway-service3-f9ef80b91b014a8490d9a910f2f34eaa.png" width="1161" height="522" class="img_ev3q"></p><p>在服务发现的场景中，我们依赖注册中心组件，这里以Nacos为例，但我们将网关服务<code>gateway-service</code>也注册到Nacos中时</p><p>本身基于Spring Cloud微服务体系的<code>DiscoverClient.java</code>接口，在Nacos组件实例下，会为我们解决各个子服务注册上来的服务发现问题，包括子服务实例对象，是否上线、心跳检测等等</p><p>而我们依赖Spring体系提供的<code>ApplicationEvent</code>事件监听体系，就可以从统一的<code>DiscoverClient</code>体系下，实现我们的自动聚合场景，这样的好处是不用关心各个注册中心的差异，在Spring Cloud的微服务体系下，注册中心需要遵循<code>DiscoverClient</code>接口进行标准实现。</p><p>在<code>knife4j-gateway</code>的服务发现场景下，我们通过<code>@EventListener</code>实现对微服务场景下的事件监听，以填充网关成文档的数据实现</p><p>监听事件回调处理源码如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@</span><span class="token maybe-class-name">Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@</span><span class="token maybe-class-name">AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">ServiceChangeListener</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final </span><span class="token maybe-class-name">DiscoveryClient</span><span class="token plain"> discoveryClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final </span><span class="token maybe-class-name">ServiceDiscoverHandler</span><span class="token plain"> serviceDiscoverHandler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final </span><span class="token maybe-class-name">Knife4jGatewayProperties</span><span class="token plain"> knife4jGatewayProperties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @</span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">EventListener</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">classes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token maybe-class-name">ApplicationReadyEvent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">class</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token maybe-class-name">HeartbeatEvent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">class</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token maybe-class-name">RefreshRoutesEvent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">class</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">debug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;discover service.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token maybe-class-name">List</span><span class="token operator">&lt;</span><span class="token known-class-name class-name">String</span><span class="token operator">&gt;</span><span class="token plain"> services </span><span class="token operator">=</span><span class="token plain"> discoveryClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getServices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token maybe-class-name">Objects</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">equals</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">knife4jGatewayProperties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getStrategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token maybe-class-name">GatewayStrategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">DISCOVER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">serviceDiscoverHandler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">discover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过注册中心在<code>DiscoverClient</code>体系下的实现，包括<code>调度(Scheduler)</code>、<code>心跳检测(HeartBeat)</code>、<code>事件回调(ApplicationEvent)</code>等机制，实现微服务网关层面文档的自动聚合。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="-5服务发现的路由聚合策略-数据来源">🐮 5.服务发现的路由聚合策略-数据来源<a class="hash-link" href="#-5服务发现的路由聚合策略-数据来源" title="标题的直接链接">​</a></h2><p>在上面章节中，我们从使用特点、两大场景(手动/服务发现)等全面介绍了knife4j-gateway组件，在文末，还是有必要和大家讲讲该组件在<code>discover</code>服务发现模式下，子服务的是数据来源处理规则</p><p>主要是4个方面，包括：</p><ul><li>基于Spring Cloud Gateway配置的routes规则解析子服务路由，数据来源：<code>spring.cloud.gateway.routes</code></li><li>在discover服务发现场景下，针对自定义添加的routes，默认再次追加，数据来源：<code>knife4j.gateway.routes</code></li><li>服务发现discover模式下，开发者在网关成的路由转发模式默认通过DiscoveryClient的默认方式转发路由，规则是<code>pattern:/service-id/**</code></li><li>接收编码方式动态注入Spring Cloud Gateway网关的路由，进行聚合转发</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-手动配置-自定义routes">5.1 手动配置-自定义Routes<a class="hash-link" href="#51-手动配置-自定义routes" title="标题的直接链接">​</a></h3><p>自定义Routes主要是开发者根据<code>Knife4j-gateway</code>组件提供的开发配置，在进行手动聚合时，填写的配置，这部分的配置是网关聚合的数据来源之一</p><p>而配置内容<code>knife4j-gateway</code>组件不会做任何处理,开发者配置什么就展示什么</p><p>示例配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">knife4j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 选择手动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> manual</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">routes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 用户服务</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">service-name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /user/v2/api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">docs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52-discoverclient自动发现">5.2 DiscoverClient自动发现<a class="hash-link" href="#52-discoverclient自动发现" title="标题的直接链接">​</a></h3><p>如果开发者在Spring Cloud Gateway网关组件下没有配置子服务的转发路由规则，完全依靠默认的转发规则(<code>pattern:/service-id/**</code>)，其实就是根据子服务名称进行转发</p><p>在这种规则下，knife4j-gateway组件会读取<code>DiscoverClient</code>组件下注入的<code>DiscoveryClientRouteDefinitionLocator</code>路由列表进行解析</p><p>在Spring Cloud Gateway网关的配置，开启该规则，配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">spring</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 路由网关配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">gateway</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># 启用了自动根据服务名建立路由</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">discovery</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">locator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">lower-case-service-id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而<code>knife4j-gateway</code>组件中，就是直接获取该模式下的子服务列表转发规则，注入到<code>knife4j-gateway</code>组件下的数据源，作为ui层面的转发依据</p><p>部分源码解析如下:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">DiscoverClientRouteServiceConvert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name">AbstactServiceRouterConvert</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final </span><span class="token maybe-class-name">DiscoveryClientRouteDefinitionLocator</span><span class="token plain"> discoveryClientRouteDefinitionLocator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final </span><span class="token maybe-class-name">Knife4jGatewayProperties</span><span class="token plain"> knife4jGatewayProperties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @</span><span class="token maybe-class-name">Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter maybe-class-name">ServiceRouterHolder</span><span class="token parameter"> holder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">debug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Spring Cloud Gateway DiscoverClient process.&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 取默认子服务的路径规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        discoveryClientRouteDefinitionLocator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getRouteDefinitions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routeDefinition </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">ServiceUtils</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">startLoadBalance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routeDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routeDefinition </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">ServiceUtils</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">includeService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routeDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> holder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> holder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getExcludeService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">subscribe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routeDefinition </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">parseRouteDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">holder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">knife4jGatewayProperties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getDiscover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routeDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getPredicates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routeDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        routeDefinition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getHost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">//others...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53-spring-gateway网关routes配置">5.3 Spring Gateway网关Routes配置<a class="hash-link" href="#53-spring-gateway网关routes配置" title="标题的直接链接">​</a></h3><p>该配置属性和自定义配置knife4j-gateway组件的routes一样，开发者一般会自定义配置子服务的路由转发策略，通过<code>spring.cloud.gateway.routes</code>进行配置</p><p>而<code>knife4j-gateway</code>会获取该部分的数据源，通过读取子服务配置的<code>Predicate</code>来获取子服务的<code>Path</code>前缀ContextPath规则进行聚合</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54-动态路由注册配置">5.4 动态路由注册配置<a class="hash-link" href="#54-动态路由注册配置" title="标题的直接链接">​</a></h3><p>动态路由注册可能在某些特殊的场景下也有需求，因此<code>knife4j-gateway</code>也会把动态注入进来的路由进行聚合，作为文档数据源进行展示</p><p>动态数据源来源于<code>RouteDefinitionRepository</code>对象</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-总结">6.👻 总结<a class="hash-link" href="#6-总结" title="标题的直接链接">​</a></h2><p>好了，本文介绍到这里也基本涵盖了knife4j-gateway网关聚合组件的方方面面，希望该组件能给你带来帮助~~!</p><p>您有更多的想法或者建议，可以关注公众号&quot;Knife4j&quot;，参与Knife4j的交流群进行沟通反馈，谢谢</p><p><img loading="lazy" alt="图5.Knife4j微信公众号" src="/assets/images/qrcode2-aaf1c042b32687b5ab24e5487179986b.png" width="1816" height="624" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>xiaoyumin</b> <!-- -->于 <b><time datetime="2023-08-13T08:08:37.000Z">2023年8月13日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-1前言" class="table-of-contents__link toc-highlight">🌾 1.前言</a></li><li><a href="#-2解决方案" class="table-of-contents__link toc-highlight">🔥 2.解决方案</a></li><li><a href="#-3深入了解" class="table-of-contents__link toc-highlight">🌚 3.深入了解</a><ul><li><a href="#-31-使用简单最低4行配置搞定聚合学习成本低" class="table-of-contents__link toc-highlight">✅ <strong>3.1 使用简单(最低4行配置搞定聚合)，学习成本低</strong></a></li><li><a href="#-32-解耦spring-cloud-gateway网关组件聚焦文档聚合功能职责单一" class="table-of-contents__link toc-highlight">✅ 3.2 解耦Spring Cloud Gateway网关组件，聚焦文档聚合功能，职责单一</a></li><li><a href="#-33-提供手动配置微服务自动发现两种灵活配置方式聚合子服务文档" class="table-of-contents__link toc-highlight">✅ <strong>3.3 提供手动配置、微服务自动发现两种灵活配置方式聚合子服务文档</strong></a></li><li><a href="#-34-可以同时聚合swagger2openapi3两种不同的规范" class="table-of-contents__link toc-highlight">✅ <strong>3.4 可以同时聚合Swagger2、OpenAPI3两种不同的规范</strong></a></li><li><a href="#-35-灵活配置聚合规则自定义排除规则支持" class="table-of-contents__link toc-highlight">✅ <strong>3.5 灵活配置聚合规则，自定义排除规则支持</strong></a></li></ul></li><li><a href="#-4聚焦两大使用场景手动服务发现自动聚合" class="table-of-contents__link toc-highlight">🐐 4.聚焦两大使用场景(手动/服务发现自动)聚合</a><ul><li><a href="#41-手动配置聚合manual" class="table-of-contents__link toc-highlight"><strong>4.1 手动配置聚合(manual)</strong></a></li><li><a href="#42-服务发现自动聚合discover" class="table-of-contents__link toc-highlight"><strong>4.2 服务发现自动聚合(discover)</strong></a></li></ul></li><li><a href="#-5服务发现的路由聚合策略-数据来源" class="table-of-contents__link toc-highlight">🐮 5.服务发现的路由聚合策略-数据来源</a><ul><li><a href="#51-手动配置-自定义routes" class="table-of-contents__link toc-highlight">5.1 手动配置-自定义Routes</a></li><li><a href="#52-discoverclient自动发现" class="table-of-contents__link toc-highlight">5.2 DiscoverClient自动发现</a></li><li><a href="#53-spring-gateway网关routes配置" class="table-of-contents__link toc-highlight">5.3 Spring Gateway网关Routes配置</a></li><li><a href="#54-动态路由注册配置" class="table-of-contents__link toc-highlight">5.4 动态路由注册配置</a></li></ul></li><li><a href="#6-总结" class="table-of-contents__link toc-highlight">6.👻 总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档指南</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/quick-start">文档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/community/simple-demo">示例</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/changelog">更新日志</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/upgrading/upgrading-to-v4">升级到v4.0</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区&amp;友链</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitter.im/knife4j/knife4j" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.oschina.net/question/tag/swagger-bootstrap-ui" target="_blank" rel="noopener noreferrer" class="footer__link-item">开源中国<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://springdoc.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">spring中文文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">关注公众号</div><ul class="footer__items clean-list"><li class="footer__item"><img src="/images/website/qrcode.jpg" width="150"></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/xiaoym/knife4j" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/xiaoymin/swagger-bootstrap-ui" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Apache License 2.0 | Copyright © 2018-2023-八一菜刀 浙ICP备18027673号-1 </div></div></div></footer></div>
<script src="/assets/js/runtime~main.2cdbce79.js"></script>
<script src="/assets/js/main.59d021b1.js"></script>
<!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKBX678" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) --></body>
</html>